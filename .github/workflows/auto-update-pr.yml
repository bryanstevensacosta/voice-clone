name: Auto Update PRs

on:
  push:
    branches:
      - master
      - main
      - develop
  # Tambi√©n se puede triggear manualmente
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-prs:
    name: Update open PRs with latest changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update all open PRs
        uses: actions/github-script@v7
        with:
          script: |
            const baseBranch = context.ref.replace('refs/heads/', '');
            const owner = 'bryanstevensacosta';
            console.log(`Base branch updated: ${baseBranch}`);

            // Get all open PRs targeting this branch
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: baseBranch,
              per_page: 100
            });

            console.log(`Found ${pullRequests.length} open PRs targeting ${baseBranch}`);

            if (pullRequests.length === 0) {
              console.log('No open PRs to update');
              return;
            }

            let updatedCount = 0;
            let skippedCount = 0;
            let errorCount = 0;

            // Update each PR
            for (const pr of pullRequests) {
              try {
                console.log(`\nProcessing PR #${pr.number}: ${pr.title}`);
                console.log(`  Branch: ${pr.head.ref}`);
                console.log(`  Author: ${pr.user.login}`);

                // Check if PR is from owner
                const isOwner = pr.user.login === owner;

                // Check if PR has approval
                const { data: reviews } = await github.rest.pulls.listReviews({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number
                });

                const hasApproval = reviews.some(review => review.state === 'APPROVED');

                // Only update if PR is from owner OR has approval
                if (!isOwner && !hasApproval) {
                  console.log(`  ‚è≠Ô∏è  Skipped: Not from owner and no approval yet`);
                  skippedCount++;
                  continue;
                }

                if (isOwner) {
                  console.log(`  ‚úì PR is from owner - will update`);
                } else {
                  console.log(`  ‚úì PR has approval - will update`);
                }

                // Check if PR branch is behind base
                const { data: comparison } = await github.rest.repos.compareCommits({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  base: pr.head.sha,
                  head: baseBranch
                });

                if (comparison.behind_by === 0) {
                  console.log(`  ‚úì Already up to date (${comparison.ahead_by} commits ahead)`);
                  skippedCount++;
                  continue;
                }

                console.log(`  ‚ö† Behind by ${comparison.behind_by} commits`);

                // Update the branch
                try {
                  await github.rest.pulls.updateBranch({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: pr.number
                  });

                  console.log(`  ‚úÖ Successfully updated PR #${pr.number}`);
                  updatedCount++;

                  // Add a comment to notify
                  const updateReason = isOwner
                    ? `PR from repository owner @${owner}`
                    : 'PR has been approved';

                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pr.number,
                    body: `üîÑ This PR has been automatically updated with the latest changes from \`${baseBranch}\`.\n\n` +
                          `**Reason**: ${updateReason}\n` +
                          `**Behind by**: ${comparison.behind_by} commit(s)\n` +
                          `**Ahead by**: ${comparison.ahead_by} commit(s)`
                  });

                } catch (updateError) {
                  if (updateError.status === 422) {
                    console.log(`  ‚ö† Cannot update: ${updateError.message}`);
                    console.log(`  This usually means there are merge conflicts`);
                    errorCount++;

                    // Comment about conflicts
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: pr.number,
                      body: `‚ö†Ô∏è Unable to automatically update this PR with latest changes from \`${baseBranch}\`.\n\n` +
                            `**Reason**: Merge conflicts detected\n\n` +
                            `Please update your branch manually:\n` +
                            `\`\`\`bash\n` +
                            `git checkout ${pr.head.ref}\n` +
                            `git fetch origin\n` +
                            `git rebase origin/${baseBranch}\n` +
                            `# Resolve conflicts if any\n` +
                            `git push --force-with-lease origin ${pr.head.ref}\n` +
                            `\`\`\``
                    });
                  } else {
                    throw updateError;
                  }
                }

              } catch (error) {
                console.error(`  ‚ùå Error updating PR #${pr.number}:`, error.message);
                errorCount++;
              }
            }

            console.log('\nüìä Summary:');
            console.log(`  ‚úÖ Updated: ${updatedCount}`);
            console.log(`  ‚è≠Ô∏è  Skipped: ${skippedCount}`);
            console.log(`  ‚ùå Errors: ${errorCount}`);
            console.log('\n‚úÖ Finished processing all PRs');

      - name: Summary
        uses: actions/github-script@v7
        with:
          script: |
            const baseBranch = context.ref.replace('refs/heads/', '');
            core.summary
              .addHeading('Auto Update PRs Summary')
              .addRaw(`Base branch: \`${baseBranch}\``)
              .addBreak()
              .addRaw('**Update Policy**: Only PRs from @bryanstevensacosta or approved PRs are updated')
              .addBreak()
              .addRaw('All eligible open PRs have been processed for updates.')
              .write();
