name: CI

"on":
  push:
    branches: [master, main, develop]
  pull_request:
    branches: [master, main, develop]
  pull_request_review:
    types: [submitted]

jobs:
  # Check if CI should run based on approval status
  check-approval:
    name: Check approval status
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}

    steps:
      - name: Check if PR is from owner or has approval
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const prAuthor = context.payload.pull_request.user.login;
            const owner = 'bryanstevensacosta';

            // If PR is from owner, always run CI
            if (prAuthor === owner) {
              console.log('PR is from owner, CI will run');
              core.setOutput('should_run', 'true');
              return;
            }

            // Check if PR has at least one approval
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const hasApproval = reviews.data.some(review => review.state === 'APPROVED');

            if (hasApproval) {
              console.log('PR has approval, CI will run');
              core.setOutput('should_run', 'true');
            } else {
              console.log('PR needs approval before CI runs');
              core.setOutput('should_run', 'false');
            }

  lint:
    name: lint
    runs-on: ubuntu-latest
    needs: [check-approval]
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request_review' ||
      (github.event_name == 'pull_request' && needs.check-approval.outputs.should_run == 'true')
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Check code formatting with Black
        run: black --check src/ tests/

      - name: Lint with Ruff
        run: ruff check src/ tests/

  type-check:
    name: type-check
    runs-on: ubuntu-latest
    needs: [check-approval]
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request_review' ||
      (github.event_name == 'pull_request' && needs.check-approval.outputs.should_run == 'true')
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Type check with MyPy
        run: mypy src/

  test:
    name: test
    runs-on: ubuntu-latest
    needs: [check-approval]
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request_review' ||
      (github.event_name == 'pull_request' && needs.check-approval.outputs.should_run == 'true')
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests with pytest
        run: pytest tests/ --cov=voice_clone --cov-report=xml --cov-report=term-missing

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  # Job to notify when CI is waiting for approval
  waiting-for-approval:
    name: Waiting for approval
    runs-on: ubuntu-latest
    needs: [check-approval]
    if: |
      github.event_name == 'pull_request' &&
      needs.check-approval.outputs.should_run == 'false'

    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('‚è≥ CI is waiting for approval')
            );

            if (!botComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: '‚è≥ CI is waiting for approval before running.\n\n' +
                      'Once this PR receives at least 1 approval, CI checks will run automatically.\n\n' +
                      'üí° Note: PRs from @bryanstevensacosta run CI immediately without approval.'
              });
            }
